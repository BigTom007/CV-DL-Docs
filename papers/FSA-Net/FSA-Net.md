# FSA-Net

<FSA-Net: Learning Fine-Grained Structure Aggregation for Head Pose Estimation from a Single Image> (CVPR 2019)

头部姿态估计

头部姿态估计问题应用很广，例如驾驶员行为监控和人类注意力检测等，同样也可以用来提高人脸识别、表情识别或注意力检测等方面的能力。

头部姿态是一个包含偏航角（yaw），俯仰角（pitch）和翻滚角（roll）的3D向量。从一张图像估计其中头部的姿态自然需要学习到2D和3D的映射关系。

有些方法使用深度图像的3D信息或者视频序列的临时信息（temporal information）来实现

大多数单帧（single-frame）姿态估计方法都使用脸部关键点来实现。但是这样会增加计算量而且模型规模会更大。因此上述方法不适合内存和计算资源有限的平台

本文提出FSA-Net，一个不需要关键点，使用直接回归从单一图像获得姿态估计的方法。基础是soft stagewise regression scheme

为了获得多尺度信息，和很多回归方法一样，本方法合并不同层级的特征图。

为了预测准确度更高，回归需要学习有意义的中间特征（intermediate feature）。

本方法的核心思想是从空间上将特征图内的像素级特征分组，分成带空间信息编码的特征集合。这些特征接下来会作为聚类的候选特征。也就是说，本方法通过学习来找到细粒度的（fine-grained）结构映射来从空间上将像素级特征分组，从而形成更强大的区域等级特征（region-level features）

提出的细粒度结构映射可以被解释为一个灵活性/柔性更强、更通用的池化工具。

卷积池化使用一个特定的window（local window）来获取固定位置的一组特征。我们的方法使用通用性更高的操作从更广的区域来池化特征。为了获得更通用（多方面）的空间信息，我们同时使用可学习和不可学习的重要性度量，通过生成互补的模型变量来创建一个强大且健壮的系统。



### 姿态估计问题方程

训练人脸图像：$ X=\{ x_n | n=1,...,N \} $

每张图像$x_n$的姿态向量：$y_n\in\mathbb{R^3}$，分量是偏航角，俯仰角，翻滚角的角度。

目标是找到一个函数$F$，它可以预测$\tilde{y}=F(x)$，并令预测值$\tilde{y}$与给定图片$x$的真实姿态$y$尽可能的匹配。

通过最小化姿态预测值和实际值之间的平均绝对误差（MAE）来求$F$

$J(X)=\frac{1}{N}\sum\limits_{n=1}^N\lVert\tilde{y_n}-y_n\lVert_1 $,        (1)

其中$\tilde{y_n}=F(x_n)$，是训练图片$x_n$的预测姿态。

这个问题自然是一个回归问题



### SSR-Net-MD

我们的方法基于SSR-Net（Soft Stagewise Regression Network），它在单张图片年龄估计中提出了一个紧凑模型（compact model）。它将年龄估计的回归问题通过划分年龄域的方式转化成了分类问题。一个网络负责分类目标，输出年龄分类的概率分布。由于采用紧凑模型，SSR-Net的分类策略是由粗到细（coarse-to-fine）。每一个阶段只负责中间的几个类别，比如在每个年龄组（age group）内只分“相对有点年轻”，“差不多这个岁数”和“相对有点老”。下一个阶段对之前的结果进行细分。

总的来说，SSR-Net采用按等级的分类方式，使用如下的soft stage-wise回归来预测年龄$\tilde{y}$：

$\tilde{y}=\sum\limits_{k=1}^K\vec{p}^{(k)}\cdot\vec{\mu}^{(k)}$,            (2)

其中$K$是阶段的数量；$\vec{p}^{(k)}$是第$k$阶段的概率分布；$\vec{\mu}^{(k)}$是一个由第$k$阶段全部年龄组的典型值组成的向量。

为了调节量化的损失和分类不确定行，引入一个位移向量$\vec{\eta}^{(k)}$来调节每个区域（bin）的中心位置，引入一个缩放因子$\Delta_k$来调整第$k$阶段全部区域（bin）的宽度，通过这种方式调整典型值$\vec{\mu}^{(k)}$

$\vec{p}^{(k)}$，$\vec{\eta}^{(k)}$和$\Delta_k$都是通过神经网络找到的。

给定输入图片，SSR-Net输出$K$组阶段参数$\{\vec{p}^{(k)},\vec{\eta}^{(k)},\Delta_k\}_{k=1}^K$，使用soft stage-wise regression来估计年龄。

soft stage-wise regression方程可以应用于任意回归问题。对于一个给定的回归问题，soft stage-wise regression方程$SSR(\{\vec{p}^{(k)},\vec{\eta}^{(k)},\Delta_k\}_{k=1}^K)$接收$K$组阶段参数然后输出回归值。



与年龄估计不同，姿态估计的输出是一个向量而非标量，我们将多维回归的SSR-Net称为SSR-Net-MD



### FSA-Net

![figure2](1.png"Figure 1")

上图是FSA-Net的结构图，输入图像经过两个流（stream）。共有$K$个阶段（图中$K=3$）。每个流在每个阶段提取一个特征图。

在第$k$阶段，阶段融合模块（stage fusion module）会将提取的两个特征图用逐元素相乘（克罗内克积$\bigotimes$）的方式融合到一起，接着经过$c\quad1\times1$卷积将合并的特征图转换成$c$通道。最后使用平均池化来将特征图尺寸缩小到$w\times h$.至此，在第$k$阶段我们就获得了一个$w\times\ h\times\ c$的特征图$U_k$.

特征图$U_k$是一个空间网格（spatial grid），每个单元格包含一个$c$维特征，表示一个具体的空间位置。

这$K$个特征图随后进入映射模块（mapping module）来获取$K\:c'$-d向量，这些向量会用来获取SSR方程的阶段输出（stage output）$\{\vec{p}^{(k)},\vec{\eta}^{(k)},\Delta_k\}$

给定$K$个尺寸为$w \times\ h \times\ c$特征图，聚合模块（aggregation module）的任务是将它们聚合成更少也更具代表性的特征。

聚合过程可以从一堆特征中蒸馏出一个更有意义的表示。

为了实现空间分组（spatial grouping），对每个特征图$U_k$，我们先通过一个评分函数计算出它的注意力图$A_k$.然后将特征图$U_k$和注意力图$A_k$传入细粒度结构映射模块。该模块通过对特征图上像素级特征进行空间加权（spatially weighting）来学习提取$n'\:c$-d的典型特征（representative features）。这些向量会被传入一个特征聚合方法来生成最终的回归典型特征集合，$V$，其中包含$K\:c'$-d个特征。向量$V_k$经过一个全连接层用于生成第$k$阶段的阶段输出$\{\vec{p}^{(k)},\vec{\eta}^{(k)},\Delta_k\}$.这些输出会替换进SSR函数用于获取姿态估计。

### Scoring function

为了更好的将特征分组，衡量像素级特征的重要性是很有必要的。给定像素级特征$u=(u_1,...,u_c)$，我们设计一个评分函数$\Phi(u)$来衡量它的重要性，从而提高空间分组的效果。因此，对于每个特征图$U_k$，获取一个重要性对象或者注意力图$A_k$，其中$A_k(i,j)=\Phi(U_k(i,j))$.

我们探索了三种评分函数。

（1）$1\times 1$卷积

（2）方差

（3）均匀分布

第一种使用一个额外的$1\times 1$卷积层作为可学习函数，如：$\Phi(u)=\sigma(w\cdot u)$，其中$\sigma$是sigmoid函数，$w$是可学习的卷积核。尽管使用$1\times 1$卷积作为评分函数可以让我们从训练数据中学到如何对特征加权，但是如果训练数据和测试数据的差异较大时，可能受到潜在的过拟合问题的影响。

受ORB通过方差来选择特征的启发，第二种方式使用方差来得到重要性评分，如：$\Phi(u)=\Sigma_{i=1}^c(u_i-\mu)^2$，其中$\mu=\frac{1}{c}\Sigma_{i=1}^{c}u_i$.方差可微但不可学习

最后一种方式，均匀分布，无差别对待所有特征，如：$\Phi(u)=1$.这种情况下$\tilde U=U$，且细粒度结构映射不起作用。

这三种方式分别对应：可学习，不可学习和不变。它们可以提供互补的信息。

我们发现这三种方式会捕捉不同的方面，最好的方式是将他们结合起来。这样，姿态估计的结果会更健壮。

### Fine-grained structure mapping

有了特征图$U_k$和注意力图$A_k$，下一步是通过细粒度结构映射提取一组典型特征$\tilde U$.

图中（b）的部分展示了这一过程。

首先将所有特征图$U_k$展成一个矩阵$U$，其第一维$n=w\times h\times K$，$U\in\mathbb{R^{n\times c}}$.

换句话说，$U$是一个2D矩阵，其中包含所有阶段的所有特征图的所有$c$-d像素级特征。

对于第$k$阶段，我们希望找到一个映射$S_k$，它可以选择并将$U$的特征分组成一个$n'$个典型特征的结合$\tilde U_k$，通过$\tilde U_k=S_kU$,其中$S_k\in\mathbb{R^{n'\times n}}$，$\tilde U_k\in\mathbb{R^{n'\times n}}$.

也就是用$n$像素级特征的线性组合，组装成$n'$个典型特征。

映射$S_k$就是线性变换，它通过获取加权平均值来实现降维。

将映射$S_k$表示成两个可学习映射$C$和$M_k$的积：$S_k=CM_k$   （4）

其中$C\in\mathbb{R^{n'\times m}}$，$M_K\in\mathbb{R^{m\times n}}$，$m$是一个参数。

映射$M_k$每层对应一个，映射$C$所有层共享。它们可以表示为：

$M_k=\sigma(f_M(A_k)) $       （5）

$C=\sigma(f_C(A))$           （6）
其中$\sigma$是sigmoid函数；$f_M$和$f_C$是由全连接层定义的两个（不同的）函数；$A=[A_1,A_2,...,A_k]$是串联后的所有注意力图。

$f_M$和$f_C$都是端到端可训练的FSA-Net的一部分。

使用可分离映射$S_k$不仅减少了参数量，同时也能够稳定训练过程。对$S_k$的每一行使用$L_1$标准化进一步增强训练稳定性。



映射$M_k$的每一行都可以折叠成$K$个尺寸为$w\times h$的映射，每一个小映射都代表像素级特征如何在空间上影响对应的行生成的典型特征。因此，$M_k$的每一行都可以当作一个细粒度结构，这种细粒度结构对于姿态估计很重要。

最终，我们将全部$\tilde U_k$拼接到一起组成最终的典型特征集合，$\tilde U = [\tilde U_1,\tilde U_2,...,\tilde U_K]$，其中$\tilde U \in\mathbb{R^{(n'\cdot K)\times c}}$.

典型特征集合$\tilde U_k$最后传进特征聚合方法来获取最终的特征集合，$V\in\mathbb{R^{K\times c}}$，用于阶段回归（stage-wise regression）
